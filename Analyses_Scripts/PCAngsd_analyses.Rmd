---
title: "PCAngsd_analyses"
author: "Hugo DENIS"
date: "2024-02-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Packages
```{r}
library(openxlsx)
library(dplyr)
library(ggplot2)
library(stringr)
library(RcppCNPy)
library(tidyr)
```

#Load covariance matrix 
```{r}
meta=read.csv('/home/hdenis/Data/GBR_data/Coral colony metadata from the ECT1_RRAP_Aspathulata_2022.csv')

path='/nvme/disk0/lecellier_data/WGS_GBR_data/Analyses_outputs/'

# Load covariance matrix 
cov <- as.matrix(read.table(paste0(path,"pcangsd.cov"))) 

#Find individuals id in covariance matrix 
list_files=read.table('/nvme/disk0/lecellier_data/WGS_GBR_data/Aligned_files/bam.filelist.txt',col.names='file')
list_files$individualID=paste0("Aspat_",sub("_.*", "",sub(".*-","",basename(list_files$file))))

#Load admixture results 
admix_df=list.files(path,"*.Q",full.names=T) %>% lapply(function(x)read.table(x) %>% mutate(K_number=as.numeric(str_sub(x,length(x)-4,length(x)-4)))) %>% bind_rows()
```

 #Perform PCA 
```{r}

mme.pca <- eigen(cov) #perform the pca using the eigen function. 

eigenvectors = mme.pca$vectors #extract eigenvectors 
pca.vectors = cbind(data.frame(individualID=list_files$individualID), data.frame(eigenvectors)) %>% merge(meta %>% dplyr::select(individualID,locationID),by="individualID") 

mycolors<-c("#1ba3c6" ,"#2cb5c0" ,"#21B087", "#33a65c" ,"#a2b627" ,"#f8b620", "#f89217", "#f06719","#e03426" ,"#f64971", "#fc719e" , "#ce69be", "#7873c0", "#4f7cba","grey")
names(mycolors)<-unique(meta$locationID)

pca = ggplot(data = pca.vectors, aes(x=X1, y=X2, colour = locationID)) + geom_point()+ theme_classic()
```

#Perform ADMIXTURE analysis
```{r}
admix_df=cbind(data.frame(individualID=rep(list_files$individualID,5)), data.frame(admix_df)) %>% gather(c(V1,V2,V3,V4,V5),key="Cluster",value="Prop") %>% mutate(K_number=paste0("K=",as.character(K_number)))


admix_plot = ggplot(data = admix_df %>% subset(K_number %in% paste0("K=",as.character(seq(2,5)))), aes(x=individualID, y=Prop, colour = Cluster,fill=Cluster)) + geom_bar(position = "stack",stat="identity") + theme_classic()+ theme(axis.text.x = element_blank(),axis.ticks.x = element_blank()) + guides(fill=F,colour=F)+facet_wrap(~K_number,ncol=1,nrow=4)
```

#Save plots 
```{r}
path_save="/home/hdenis/Coral-Genomics/Figures/ANGSD_plot/"

ggsave(pca,filename=paste0(path_save,"Test_pcangsd",".png"),width=14,height=10,dpi=320)
ggsave(admix_plot,filename=paste0(path_save,"Test_admix_plot",".png"),width=14,height=10,dpi=320)
```

