---
title: "BAM_file_statistics"
author: "Hugo DENIS"
date: "2024-01-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Packages
```{r}
library(xlsx)
library(dplyr)
library(ggplot2)
```

#### This scripts uses mapped BAM files to produce basic statistics on A.spathulata WGS data ####   
# This includes coverage, base quality, sequencing depth, mapping quality ...

#Load samples metadata (A.spathulata 2022 only)
```{r}
meta=read.csv('/home/hugo/PhD/GBR_Data/Coral colony metadata from the ECT1_RRAP_Aspathulata_2022.csv')
```

#Load BAM stats files  
```{r}
path='/home/hugo/PhD/Genomics/Raw_data_processing/BAM_statistics/'

#Trimmed statistics -> problem with disk 
a=read.table(paste0('/data1/WGS_Aspat_GBR/Trimmed_files/','RRAP-ECT01-2022-Aspat-CBHE-1718_L1_sum.txt'))

#Sample names and read counts
df_stat=data.frame(sample.name=read.table(paste0(path,'sample_name.txt'))[1],mapped=read.table(paste0(path,'allCounts.txt'))[1],unmapped=read.table(paste0(path,'unmappedCounts.txt'))[1])
colnames(df_stat)=c('sample.name','mapped','unmapped')
df_stat$individualID=paste0(sapply(strsplit(df_stat$sample.name,"-"),"[[",4),"_",sub("_.*", "",sub(".*-","",df_stat$sample.name)))
df_stat=df_stat %>% merge(meta[,c("individualID","locationID")],by="individualID")
df_stat=df_stat %>% mutate(Ref=sub(".*_", "",sample.name))
df_stat=df_stat[-c(1,2,3),]

#Duplicate stats
dup_stat=list.files(path,"*dup_metrics.txt",full.names = T) %>% lapply(function(x)read.table(x,skip=6,nrows=1,header=T) %>% mutate(sample.name=sub("_marked.*", "",basename(x)))) %>% bind_rows
dup_stat$individualID=paste0(sapply(strsplit(dup_stat$sample.name,"-"),"[[",4),"_",sub("_.*", "",sub(".*-","",dup_stat$sample.name)))
dup_stat=dup_stat %>% mutate(Ref=sub(".*_", "",sample.name))

#Coverage 
cov_stat=list.files(path,"*coverage.txt",full.names = T) %>% lapply(function(x)read.table(x,header=T,comment.char="",col.names=c('rname',"startpos","endpos","numreads","covbases","coverage","meandepth","meanbaseq","meanmapq")) %>% mutate(sample.name=sub("-coverage.*", "",basename(x)))) %>% bind_rows
cov_stat$individualID=paste0(sapply(strsplit(cov_stat$sample.name,"-"),"[[",4),"_",sub("_.*", "",sub(".*-","",cov_stat$sample.name)))
cov_stat=cov_stat %>% mutate(Ref=sub(".*_", "",sample.name))

#flagstats
flag_stat=list.files(path,"*flagstats.txt",full.names = T) %>% lapply(function(x)read.table(x,header=F,sep="\t",col.names=c('value',NA,'metric'))[,c(1,3)]  %>% mutate(sample.name=sub("-flag.*", "",basename(x)))) %>% bind_rows

#Mapped sequence lenght  
index_stat=list.files(path,"*index_stats.txt",full.names = T) %>% lapply(function(x)read.table(x,col.names=c('Ref_name','Seq_length','Mapped_segment','Unmapped_segment')) %>% mutate(sample.name=sub("-index.*", "",basename(x)))) %>% bind_rows


```

#Make statistics plot 
```{r}
#Percentage of mapped reads to each reference genome 
map_plot=df_stat %>% ggplot(aes(x=individualID,y=100*mapped/(mapped+unmapped),fill=Ref)) + geom_col(colour='black',position='dodge2') + theme_classic() + labs(x='Sample',y='% Mapped reads',fill='Ref genome') + theme(axis.text.x = element_text(angle=45,vjust = 1, hjust = 1)) + coord_cartesian(ylim=c(85,100))

#Percentage of duplication per sample 
dup_plot=dup_stat %>% ggplot(aes(x=individualID,y=PERCENT_DUPLICATION,fill=Ref)) + geom_col(colour='black',position='dodge2') + theme_classic() + labs(x='Sample',y='% Duplicated reads',fill='Ref genome') + theme(axis.text.x = element_text(angle=45,vjust = 1, hjust = 1))

#Coverage
cov_sum=cov_stat %>% group_by(Ref,individualID) %>% dplyr::summarize(meancov=mean(coverage),sdcov=sd(coverage),meandep=mean(meandepth),sddep=sd(meandepth),meanbq=mean(meanbaseq),sdbq=sd(meanbaseq),meanmq=mean(meanmapq),sdmq=sd(meanmapq))

cov_plot=cov_sum %>% ggplot(aes(x=individualID,y=meancov,fill=Ref))   + geom_col(colour='black',position='dodge2') +
  geom_errorbar(aes(ymin=meancov-sdcov, ymax=meancov+sdcov), width=.2,
                 position=position_dodge(.9))+ theme_classic() + labs(x='Sample',y='% Duplicated reads',fill='Ref genome') + theme(axis.text.x = element_text(angle=45,vjust = 1, hjust = 1))



x11()
plot(cov_plot)
```


